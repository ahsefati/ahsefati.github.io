<style>
     ::backdrop {
        background-color: white;
    }
    
    * {
        box-sizing: border-box;
    }
    
    @font-face {
        font-family: 'iransans';
        src: url('fonts/IRANSans.ttf');
    }
    
    .font-iran {
        font-family: 'iransans';
    }
    
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p {
        direction: rtl;
    }
    
    .center {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
    }
    
    .center-icon {
        margin: 0;
        position: absolute;
        top: 40%;
        left: 46%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
    }
    
    .center-h {
        margin: 0;
        position: absolute;
        left: 50%;
        top: 40%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
    }
    /* LOADER AHS */
    
    .loader {
        border: 1px solid #f3f3f300;
        border-radius: 50%;
        border-top: 16px solid rgb(10, 146, 16);
        border-bottom: 16px solid rgb(10, 42, 146);
        margin-top: 10px;
        margin-left: 10px;
        margin-bottom: 5%;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 1.5s linear infinite;
        animation: spin 1.5s linear infinite;
    }
    
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }
    
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    /* FINISH LOADER AHS */
    /* MAIN ICON RIGHT PAGE */
    
    .icon-bar {
        width: 5%;
        height: 93%;
        position: sticky;
        right: 4px;
        float: right;
    }
    
    .icon-bar a {
        display: block;
        text-align: center;
        transition: all 0.5s ease;
        color: rgb(10, 42, 146);
        padding: 70% 5px 0px 0px;
    }
    
    .icon-bar-D {
        font-size: 280%;
    }
    
    .icon-bar-M {
        font-size: 120%;
    }
    
    .icon-bar a:hover {
        color: rgb(10, 146, 16);
    }
    
    .navbar {
        overflow: hidden;
        background-color: inherit;
        position: fixed;
        bottom: 0;
        left: 0px;
        width: 100%;
        height: 6.7%;
    }
    
    .navbar a {
        float: left;
        display: block;
        color: rgb(10, 146, 16);
        text-align: center;
        padding: 10px;
        text-decoration: none;
    }
    
    .navbar-M {
        font-size: 110%;
    }
    
    .navbar-D {
        font-size: 180%;
    }
    
    .navbar a:hover {
        background: #f1f1f1;
        color: blue;
    }
    
    .navbar a.active {
        background-color: white;
        color: #4CAF50;
    }
    /* FINISH MAIN ICON RIGHT PAGE */
    /* MAIN BODY */
    
    .active {
        color: rgb(10, 146, 16);
    }
    
    .mainbody {
        border: 4px dotted rgb(19, 182, 41);
        border-radius: 1%;
        margin-top: 0.5%;
        margin-left: 2%;
        width: 92%;
        height: 92.5%;
    }
    /* FOR Table */
    
    #myTable {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid rgb(255, 255, 255);
        font-size: 18px;
        direction: rtl;
    }
    
    #myTable th,
    #myTable td {
        text-align: center;
        padding: 12px;
    }
    
    #myTable tr {
        border-bottom: 1px solid rgb(255, 255, 255);
    }
    
    #myTable tr.header,
    #myTable tr:hover {
        background-color: rgb(22, 230, 56);
    }
    
    .masked {
        display: none;
    }
    
    .input-table {
        height: 30px;
        width: 85%;
        text-align: center;
        font-family: 'iransans';
        direction: rtl;
    }
    /* FOR FLIP CARD in Support div */
    
    .flip-card {
        background-color: transparent;
        width: 32.2%;
        height: 31%;
        float: right;
        margin: 0.5%;
    }
    
    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    }
    
    .flip-card:hover .flip-card-inner {
        transform: rotateY(180deg);
    }
    
    .flip-card-front-new,
    .flip-card-front-inp,
    .flip-card-front-close,
    .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }
    
    .flip-card-front-new {
        background-color: rgb(238, 163, 24);
        color: black;
    }
    
    .flip-card-front-inp {
        background-color: rgb(218, 215, 60);
        color: black;
    }
    
    .flip-card-front-close {
        background-color: rgb(84, 201, 73);
        color: black;
    }
    
    .flip-card-back {
        background-color: #001aff;
        color: white;
        transform: rotateY(180deg);
    }
    /* FINISH Support div */
</style>

<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='-1'>
    <meta http-equiv='pragma' content='no-cache'>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
</head>

<div id="preload" class="w3-center" style="margin-top: 20%;">
    <h1 id="loader/0" style="display: none;font-size: 300%;" class="w3-animate-left">تــ</h1>
    <h1 id="loader/1" style="display: none;font-size: 300%;" class="w3-animate-left">یــ</h1>
    <h1 id="loader/2" style="display: none;font-size: 300%;" class="w3-animate-left">نـ</h1>
    <h1 id="loader/3" style="display: none;font-size: 300%;" class="w3-animate-left">ا</h1>
    <h1 id="loader/4" style="display: none;font-size: 300%;" class="w3-animate-left">یــ</h1>
    <h1 id="loader/5" style="display: none;font-size: 300%;" class="w3-animate-left">و</h1>
    <h3 id="loader/6" style="display: none;direction: rtl;" class="w3-animate-left w3-center">This is future</h3>

    <script>
        loading()

        function loading() {
            setTimeout(() => {
                document.getElementById("loader/0").style.display = "inline"
            }, 300);
            setTimeout(() => {
                document.getElementById("loader/1").style.display = "inline"
            }, 600);
            setTimeout(() => {
                document.getElementById("loader/2").style.display = "inline"
            }, 900);
            setTimeout(() => {
                document.getElementById("loader/3").style.display = "inline"
            }, 1200);
            setTimeout(() => {
                document.getElementById("loader/4").style.display = "inline"
            }, 1500);
            setTimeout(() => {
                document.getElementById("loader/5").style.display = "inline"
            }, 1700);
            setTimeout(() => {
                document.getElementById("loader/6").style.display = "block"
            }, 2000);
            setTimeout(() => {
                document.getElementById("preload").style.display = "none"
                document.getElementById("icon-bar-D").style.display = "block"
                document.getElementById("icon-bar-M").style.display = "block"
                document.getElementById("mainbody").style.display = "block"
                showNodes()
            }, 2500);

        }


        function loadforawhile() {
            document.getElementById("loading").style.display = "block"
            setTimeout(() => {
                document.getElementById("loading").style.display = "none"
            }, 800);
        }

        function makeActive(id) {
            for (var i = 1; i <= 5; i++) {
                document.getElementById(i + "-icon").classList.remove("active")
            }
            document.getElementById(id + "-icon").classList.add("active")
        }

        function hideAll() {
            document.getElementById("table").style.display = 'none'
            document.getElementById("table-navbar-D").style.display = 'none'
            document.getElementById("table-navbar-M").style.display = 'none'
            document.getElementById("settingwashing-navbar-D").style.display = 'none'
            document.getElementById("settingwashing-navbar-M").style.display = 'none'
            document.getElementById("settingWashing").style.display = "none"
            document.getElementById("current-plot-washing").style.display = "none"
            document.getElementById("washingplot-navbar-D").style.display = "none"
            document.getElementById("washingplot-navbar-M").style.display = "none"
            document.getElementById("income-system-plot").style.display = "none"
            document.getElementById("economic").style.display = "none"
            document.getElementById("incomeplot-navbar-D").style.display = "none"
            document.getElementById("incomeplot-navbar-M").style.display = "none"
            document.getElementById("updateOff-div").style.display = "none"
            document.getElementById("support-div").style.display = "none"
            document.getElementById('popup-div').style.display = 'none'
            document.getElementById("nodes").style.display = "none"
            document.getElementById("nodes-navbar-D").style.display = "none"
            document.getElementById("nodes-navbar-M").style.display = "none"

        }

        function showNodes() {
            loadforawhile()
            createTable()
            setTimeout(() => {
                hideAll()

                document.getElementById("nodes").style.display = "block"
                document.getElementById("nodes-navbar-D").style.display = "block"
                document.getElementById("nodes-navbar-M").style.display = "block"

                makeActive('1')

                $.ajax({
                    type: 'POST',
                    url: 'php/getGraph.php',
                    data: {

                    },
                    success: function(response) {

                    }
                });

                updateGraph()

            }, 800);

        }

        function createTable() {
            $.ajax({
                type: 'POST',
                url: 'php/getTable.php',
                data: {

                },
                success: function(response) {
                    tableDataJSON = JSON.parse(response)
                    console.log(tableDataJSON)

                    uniNameJSON = tableDataJSON.unis
                    dormNameJSON = tableDataJSON.dorms
                    blockNameJSON = tableDataJSON.blocks
                    numberOfWashings = tableDataJSON.nodes.length

                    var myTable = document.getElementById("myTable")
                    myTable.innerHTML = ''

                    var trElem = document.createElement("tr")
                    trElem.classList.add("header")
                    var thCode = document.createElement("th")
                    thCode.style.width = "10%"
                    thCode.innerText = "شماره"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "25%"
                    thCode.classList.add("masked")
                    thCode.innerText = "دانشگاه"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "20%"
                    thCode.classList.add("masked")
                    thCode.innerText = "خوابگاه"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "20%"
                    thCode.classList.add("masked")
                    thCode.innerText = "بلوک"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "10%"
                    thCode.innerText = "سلامت"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "10%"
                    thCode.innerText = "اتصال"
                    trElem.appendChild(thCode)
                    var thCode = document.createElement("th")
                    thCode.style.width = "5%"
                    thCode.innerText = "تنظیمات"
                    trElem.appendChild(thCode)

                    myTable.appendChild(trElem)


                    for (var i = 0; i < numberOfWashings; i++) {
                        var trElem = document.createElement("tr")

                        var tdCodeNumberElem = document.createElement('td')
                        tdCodeNumberElem.innerText = tableDataJSON.nodes[i].id
                        tdCodeNumberElem.id = tableDataJSON.nodes[i].id + "/code"
                        trElem.appendChild(tdCodeNumberElem)

                        var tdUniNameElem = document.createElement('td')
                        tdUniNameElem.innerText = uniNameJSON[tableDataJSON.nodes[i].uni_id] //
                        tdUniNameElem.id = tableDataJSON.nodes[i].id + "/uni"
                        tdUniNameElem.style.display = "none"
                        trElem.appendChild(tdUniNameElem)


                        var tdDormNameElem = document.createElement('td')
                        tdDormNameElem.innerText = dormNameJSON[tableDataJSON.nodes[i].dorm_id] //
                        tdDormNameElem.id = tableDataJSON.nodes[i].id + "/dorm"
                        tdDormNameElem.style.display = "none"
                        trElem.appendChild(tdDormNameElem)

                        var tdBlockNameElem = document.createElement('td')
                        tdBlockNameElem.innerText = blockNameJSON[tableDataJSON.nodes[i].block_id]
                        tdBlockNameElem.id = tableDataJSON.nodes[i].id + "/block"
                        tdBlockNameElem.style.display = "none"
                        trElem.appendChild(tdBlockNameElem)

                        var tdHealthElem = document.createElement('td')
                        healthText = "خراب"
                        if (tableDataJSON.nodes[i].health == 1) {
                            healthText = "سالم"
                        }
                        tdHealthElem.innerText = healthText
                        tdHealthElem.id = tableDataJSON.nodes[i].id + "/health"
                        trElem.appendChild(tdHealthElem)

                        connText = "قطع"
                        if (tableDataJSON.nodes[i].connection == 1) {
                            connText = "وصل"
                        }
                        var tdConnElem = document.createElement('td')
                        tdConnElem.innerText = connText
                        tdConnElem.id = tableDataJSON.nodes[i].id + "/connect"
                        trElem.appendChild(tdConnElem)

                        var tdSettingElem = document.createElement('td')
                        var iconSettingElem = document.createElement('i')
                        iconSettingElem.id = tableDataJSON.nodes[i].id //
                        iconSettingElem.classList.add('fa')
                        iconSettingElem.classList.add('fa-gear')
                        iconSettingElem.style.fontSize = "28px"
                        iconSettingElem.style.color = "green"
                        iconSettingElem.onclick = function() {
                            showSettingWashing(event)
                        }
                        tdSettingElem.appendChild(iconSettingElem)

                        trElem.appendChild(tdSettingElem)

                        myTable.appendChild(trElem)

                    }
                }
            });
        }

        function showTable() {
            loadforawhile()

            createTable()

            $.ajax({
                type: 'POST',
                url: 'php/getVersions.php',
                data: {

                },
                success: function(response) {
                    response = JSON.parse(response)
                    var len = response.length
                    console.log("len: " + len)
                    console.log(response)
                    selectUpdate = document.getElementById("versionToUpdate")
                    selectUpdate.innerHTML = ''
                    for (var i = 0; i < len; i++) {
                        console.log(response[i])
                        opt = document.createElement('option')
                        opt.value = response[i]
                        opt.innerText = response[i]
                        selectUpdate.appendChild(opt)
                    }
                }
            });

            setTimeout(() => {
                hideAll()

                document.getElementById("table").style.display = 'block'
                document.getElementById("table-navbar-D").style.display = 'block';
                document.getElementById("table-navbar-M").style.display = 'block';
                makeActive('2')

            }, 1200);
        }

        function showSettingWashing(event, node_id = null) {
            if (event == false) {
                mainId = node_id
            } else {
                mainId = event.target.id

            }

            console.log(mainId)

            loadforawhile()
            code = document.getElementById(mainId + "/code").innerText
            uniName = document.getElementById(mainId + "/uni").innerText
            dormName = document.getElementById(mainId + "/dorm").innerText
            blockName = document.getElementById(mainId + "/block").innerText
            healthStat = document.getElementById(mainId + "/health").innerText
            connStat = document.getElementById(mainId + "/connect").innerText
            document.getElementById("washing-number-special-D").innerText = code
            document.getElementById("washing-uni-special-D").innerText = uniName
            document.getElementById("washing-dorm-special-D").innerText = dormName
            document.getElementById("washing-block-special-D").innerText = blockName
            document.getElementById("washing-health-special-D").innerText = healthStat
            document.getElementById("washing-connect-special-D").innerText = connStat

            setInterval(() => {
                $.ajax({
                    type: 'POST',
                    url: 'php/getNowCurrent.php',
                    data: {
                        node_id: code
                    },
                    success: function(response) {
                        currentDataJSON = JSON.parse(response)
                        document.getElementById("washing-current-special-D").innerText = currentDataJSON.current
                    }
                });
            }, 2000000);


            setTimeout(() => {
                hideAll()
                document.getElementById("settingWashing").style.display = "block"
                document.getElementById("settingwashing-navbar-D").style.display = 'block'
                document.getElementById("settingwashing-navbar-M").style.display = 'block'

            }, 800);

        }

        function showSettingWashingPlot() {
            loadforawhile()

            setTimeout(() => {
                hideAll()

                document.getElementById("current-plot-washing").style.display = "block"
                document.getElementById("washingplot-navbar-D").style.display = "block"
                document.getElementById("washingplot-navbar-M").style.display = "block"

            }, 800);

            setTimeout(() => {
                xx = [1, 2, 3, 4]
                yy = [1, 2, 3, 4]
                var trace1 = {
                    x: xx,
                    y: yy,
                    type: 'scatter'
                };

                var data = [trace1];
                Plotly.newPlot('current-plot-washing', data);
            }, 850);
        }

        function showIncomeChart() {
            loadforawhile()

            setTimeout(() => {
                hideAll()

                document.getElementById("economic").style.display = "block"
                document.getElementById("incomeplot-navbar-D").style.display = "block"
                document.getElementById("incomeplot-navbar-M").style.display = "block"

                makeActive('3')

            }, 800);

        }

        function showSupport() {
            loadforawhile()
            setTimeout(() => {
                hideAll()

                document.getElementById("support-div").style.display = "block"

                makeActive('5')

            }, 800);
        }

        function showUpdateOff() {
            loadforawhile()

            setTimeout(() => {
                hideAll()
                $.ajax({
                    type: 'POST',
                    url: 'php/getVersions.php',
                    data: {

                    },
                    success: function(response) {
                        response = JSON.parse(response)
                        var len = response.length
                        console.log("len: " + len)
                        console.log(response)
                        selectUpdate = document.getElementById("versionToUpdate")
                        selectUpdate.innerHTML = ''
                        for (var i = 0; i < len; i++) {
                            console.log(response[i])
                            opt = document.createElement('option')
                            opt.value = response[i]
                            opt.innerText = response[i]
                            selectUpdate.appendChild(opt)
                        }
                    }
                });


                document.getElementById("updateOff-div").style.display = "block"




                makeActive('4')

            }, 800);
        }


        function fullScreen(elementId) {
            var elem = document.getElementById("" + elementId);
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE/Edge */
                elem.msRequestFullscreen();
            }
        }
    </script>
</div>



<body>
    <!-- ICON BAR for DESKTOP & MOBILE -->
    <div id="icon-bar-D" class="icon-bar icon-bar-D w3-animate-right w3-hide-small" hidden>
        <h2 class="w3-center font-iran" style="color: green;">تینایو</h2>
        <div class="center-h">
            <a class="active" href="#nodes"><i id="1-icon" onclick="showNodes()" class="fa fa-snowflake-o"></i></a>
            <a onclick="showTable()" href="#table"><i id="2-icon" class="fa fa-table" title="جدول لباسشویی ها"></i></a>
            <a onclick="showIncomeChart()" href="#income"><i id="3-icon"  class="fa fa-line-chart" title="نمودارهای درآمد و مخارج"></i></a>
            <a onclick="showUpdateOff()" href="#upadate-off"><i id="4-icon" class="fa fa-refresh" title="به روزرسانی/خاموش نمودن تمامی نودها"></i></a>
            <a onclick="showSupport()" href="#support"><i id="5-icon" class="fa fa-user-plus" title="مشاهده ی پیام های پشتیبانی"></i></a>
        </div>
    </div>

    <div id="icon-bar-M" class="icon-bar icon-bar-M w3-animate-right w3-hide-medium w3-hide-large" hidden>
        <div class="center-h">
            <a class="active" href="#nodes"><i id="1-icon" onclick="showNodes()" class="fa fa-snowflake-o"></i></a>
            <a onclick="showTable()" href="#table"><i id="2-icon" class="fa fa-table" title="جدول لباسشویی ها"></i></a>
            <a onclick="showIncomeChart()" href="#income"><i id="3-icon"  class="fa fa-line-chart" title="نمودارهای درآمد و مخارج"></i></a>
            <a onclick="showUpdateOff()" href="#upadate-off"><i id="4-icon" class="fa fa-refresh" title="به روزرسانی/خاموش نمودن تمامی نودها"></i></a>
            <a onclick="showSupport()" href="#support"><i id="5-icon" class="fa fa-user-plus" title="مشاهده ی پیام های پشتیبانی"></i></a>
        </div>
    </div>

    <!-- MAIN BODY -->
    <div id="mainbody" class="mainbody" style="overflow-y: auto;overflow-x: auto;" hidden>
        <div id="loading" class="center-icon" style="z-index: 10000;" hidden>
            <div class="loader"></div>
        </div>

        <div id="msg-modal-div" class="w3-center w3-full" style="z-index: 10000;" hidden>
            <h3 style="background-color: #4CAF50;padding: 2%;font-family: 'iransans';" id="msg-modal-text"></h3>
        </div>


        <!-- NODES -->
        <div id="nodes" style="z-index: -1;" hidden></div>


        <!-- TABLE -->
        <div id="table" style="overflow-y: auto;overflow-x: auto;" class="w3-animate-left" hidden>
            <table id="myTable" style="font-family: 'iransans';">
                <tr class="header">
                    <th style="width:10%;">شماره</th>
                    <th style="width:25%;" class="masked">دانشگاه</th>
                    <th style="width:20%;" class="masked">خوابگاه</th>
                    <th style="width:20%;" class="masked">بلوک</th>
                    <th style="width:10%;">سلامت</th>
                    <th style="width:10%;">اتصال</th>
                    <th style="width: 5%;">تنظیمات</th>
                </tr>


            </table>
        </div>

        <!-- SETTING Washing Div -->
        <div id="settingWashing" class="w3-center w3-animate-left w3-container" style="text-align: center;direction: rtl;margin-top: 1%;" hidden>
            <img class="w3-third" src="images/logo.png">
            <div class="w3-twothird">
                <div class="w3-hide-small">
                    <div class="w3-half">
                        <h2 id="washing-number-special-D">9523076</h2>
                        <h2 id="washing-uni-special-D">امیرکبیر</h2>
                        <h2 id="washing-dorm-special-D">شرفی</h2>
                        <h2 id="washing-block-special-D">بلوک یک</h2>
                        <h2 id="washing-health-special-D">سالم</h2>
                        <h2 id="washing-connect-special-D">متصل</h2>
                        <h2 id="washing-current-special-D">10 آمپر</h2>
                    </div>
                    <div class="w3-half">
                        <h2>شماره لباسشویی: </h2>
                        <h2>دانشگاه: </h2>
                        <h2>خوابگاه: </h2>
                        <h2>بلوک: </h2>
                        <h2>وضعیت سلامت: </h2>
                        <h2>وضعیت اتصال: </h2>
                        <h2>جریان کنونی: </h2>
                    </div>
                </div>

                <div class="w3-hide-large w3-hide-medium">
                    <div class="w3-full font-iran">
                        <h3 class="font-iran" id="washing-number-special-M">9523076</h3>
                        <h3 id="washing-uni-special-M">دانشگاه: امیرکبیر</h3>
                        <h3 id="washing-dorm-special-M">خوابگاه: شرفی</h3>
                        <h3 id="washing-block-special-M">بلوک: بلوک یک</h3>
                        <h3 id="washing-health-special-M">وضعیت سلامت: سالم</h3>
                        <h3 id="washing-connect-special-M">وضعیت اتصال: متصل</h3>
                        <h3 id="washing-current-special-M">10جریان: آمپر</h3>
                    </div>
                </div>

            </div>
        </div>

        <!-- Ploting DIV for each washing -->
        <div id="current-plot-washing"></div>

        <!-- Ploting DIV for income of system -->
        <div class="w3-full w3-card-4" style="margin-top: 5%;" id="income-system-plot"></div>

        <div id="economic" style="margin-top: 10%;" hidden>
            <div class="w3-third w3-card-4 w3-green" style="text-align: center;border: white solid 5px;">
                <h2>سود کل:</h2>
                <h2>14000000</h2>
            </div>
            <div class="w3-third w3-card-4 w3-blue" style="text-align: center;border: white solid 5px;">
                <h2>درآمد کل:</h2>
                <h2>14000000</h2>
            </div>
            <div class="w3-third w3-card-4 w3-red" style="text-align: center;border: white solid 5px;">
                <h2>هزینه کل:</h2>
                <h2>14000000</h2>
            </div>
        </div>


        <!-- UPADTE and POWEROFF ALL NODES -->
        <div id="updateOff-div" class="w3-full w3-card-4 w3-animate-top" style="margin-top: 10%;" hidden>
            <div class="w3-half" style="text-align: center;">
                <div class="w3-full w3-green w3-card-4" style="text-align: center;border: white solid 2px;">
                    <h1 class="w3-full font-iran">به روزرسانی تمام نود ها</h1>
                    <h5 class="w3-full font-iran">با فشردن دکمه ی زیر دستور به روزرسانی برای تمام نودها ارسال خواهد شد. قبل از به روزرسانی از صحت نسخه ی جدید مطمئن شوید.</h5>
                </div>
                <button onclick="showPopUp('updateAllNodes')" class="w3-btn w3-cart-4 w3-green font-iran">به روزرسانی</button>
            </div>

            <div class="w3-half" style="text-align: center;">
                <div class="w3-full w3-red w3-card-4" style="text-align: center;border: white solid 2px;">
                    <h1 class="w3-full font-iran">قطع تمام نود ها</h1>
                    <h5 class="w3-full font-iran">با کلیک بر گزینه ی زیر، تمام نودهای متصل به سیستم قطع خواهند شد. قبل از کلیک از لزوم استفاده از آن مطمئن شوید.</h5>
                </div>
                <button onclick="showPopUp('turnoffAllNodes')" class="w3-btn w3-cart-4 w3-red font-iran">قطع کل سیستم</button>
            </div>

        </div>



        <!-- Support div -->
        <div id="support-div" style="text-align: center;" hidden>
            <div class="w3-row w3-black">
                <a href="javascript:void(0) " onclick="openSupport(event, 'closedTickets'); ">
                    <div class="w3-third tablink w3-bottombar w3-hover-gray w3-padding ">تیکت های بسته شده</div>
                </a>
                <a href="javascript:void(0) " onclick="openSupport(event, 'inprocessTickets'); ">
                    <div onclick="incomeChart()" class="w3-third tablink w3-bottombar w3-hover-gray w3-padding ">تیکت های درحال بررسی</div>
                </a>
                <a href="javascript:void(0) " onclick="openSupport(event, 'newTickets'); ">
                    <div class="w3-third tablink w3-bottombar w3-border-green w3-hover-gray w3-padding ">تیکت های جدید</div>
                </a>
            </div>

            <div id="closedTickets" class="support" hidden>
                <div class="flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front-close">
                            <h2 id="titleOfIssue">خرابی لباسشویی</h2>
                            <h4 id="numberOfWashingIssue">9523076</h4>
                            <h4 id="dateOfCreatingIssue">2 خرداد 99</h4>
                            <h4 id="dateOfCreatingIssue">ساعت 7:30:23 صبح</h4>
                        </div>
                        <div class="flip-card-back">
                            <h6 id="descriptionOfIssue" title="">برای مشاهده توضیحات ماوس را روی این متن نگه دارید</h6>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inprocessTickets" class="support" hidden>
                <div class="flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front-inp">
                            <h2 id="titleOfIssue">خرابی لباسشویی</h2>
                            <h4 id="numberOfWashingIssue">9523076</h4>
                            <h4 id="dateOfCreatingIssue">2 خرداد 99</h4>
                            <h4 id="dateOfCreatingIssue">ساعت 7:30:23 صبح</h4>
                        </div>
                        <div class="flip-card-back">
                            <h6 id="descriptionOfIssue" title="">برای مشاهده توضیحات ماوس را روی این متن نگه دارید</h6>
                            <hr style="width:100%;color: white;">
                            <input id="replyTextIssue" style="text-align: right;direction: rtl; width: 90%;" type="text">
                            <button class="w3-btn w3-green w3-full" style="margin-top: 1%;">ارسال پاسخ</button>
                            <button style="bottom: 0; margin-top: 1%;" class="w3-btn w3-yellow">تبدیل به بسته شده</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="newTickets" class="support">

                <div class="flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front-new">
                            <h2 id="titleOfIssue">خرابی لباسشویی</h2>
                            <h4 id="numberOfWashingIssue">9523076</h4>
                            <h4 id="dateOfCreatingIssue">2 خرداد 99</h4>
                            <h4 id="dateOfCreatingIssue">ساعت 7:30:23 صبح</h4>
                        </div>
                        <div class="flip-card-back">
                            <h6 id="descriptionOfIssue" title="">برای مشاهده توضیحات ماوس را روی این متن نگه دارید</h6>
                            <hr style="width:100%;color: white;">
                            <input id="replyTextIssue" style="text-align: right;direction: rtl; width: 90%;" type="text">
                            <button class="w3-btn w3-green w3-full" style="margin-top: 1%;">ارسال پاسخ</button>
                            <button style="bottom: 0; margin-top: 1%;" class="w3-btn w3-yellow">تبدیل به در حال بررسی</button>
                        </div>
                    </div>
                </div>

            </div>

        </div>


        <div id="popup-div" style="text-align: center;padding: 1%;">
            <div class="w3-full font-ir w3-orange">
                <h4 class="font-iran">از انجام این کار مطمئن هستید ؟</h4>
                <h5 class="font-iran">ورژن را انتخاب کنید:</h5>
                <select id="versionToUpdate" style="visibility: hidden;">
                    
                </select>
                <br>
                <button class="font-iran w3-btn w3-green" id="yes-popup">بله</button>
                <button class="font-iran w3-btn w3-red" onclick="document.getElementById('popup-div').style.display='none'">خیر</button>
            </div>
        </div>
    </div>



    <!-- FOOTERS -->

    <!-- NODES -->
    <div id="nodes-navbar-D" class="navbar navbar-D  w3-hide-small" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#fullscreen" id="fullScreen-icon" onclick="fullScreen('nodes')"><i onclick="incomeChart()" class="fa fa-search-plus" title="بزرگ نمایی به صورت تمام صفحه"></i></a>
            <a href="#nodes" id="database/m" onclick="showNodes()"><i class="fa fa-refresh" title="به روزرسانی اطلاعات"></i></a>
        </div>
    </div>
    <div id="nodes-navbar-M" class="navbar navbar-M  w3-hide-medium w3-hide-large" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#fullscreen" id="fullScreen-icon" onclick="fullScreen('nodes')"><i onclick="incomeChart()" class="fa fa-search-plus" title="بزرگ نمایی به صورت تمام صفحه"></i></a>
            <a href="#nodes" id="database/m" onclick="showNodes()"><i class="fa fa-refresh" title="به روزرسانی اطلاعات"></i></a>
        </div>
    </div>


    <!-- TABLE -->
    <div id="table-navbar-D" class="navbar navbar-D  w3-hide-small" style="z-index: 10000;" hidden>
        <div class="center">
            <input class="w3-animate-top input-table" type="text" id="myInput1" onkeyup="searchFunc1('myInput1')" placeholder="جست و جو">
        </div>
    </div>
    <div id="table-navbar-M" class="navbar navbar-M  w3-hide-medium w3-hide-large" style="z-index: 10000;" hidden>
        <div class="center">
            <input class="w3-animate-top input-table" type="text" id="myInput11" onkeyup="searchFunc1('myInput11')" placeholder="جست و جو">
        </div>
    </div>


    <!-- Washing Setting -->
    <div id="settingwashing-navbar-D" class="navbar navbar-D w3-hide-small" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#current-plot" id="current-plot-icon" onclick="showTable()"><i onclick="showTable()" class="fa fa-backward" title="بازگشت به جدول لباسشویی ها"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showSettingWashingPlot()"><i onclick="showSettingWashingPlot()" class="fa fa-bar-chart" title="نمایش نمودار جریان این نود"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showPopUp('turnoffJustNode')"><i onclick="showPopUp('turnoffJustNode')" class="fa fa-power-off" title="قطع/وصل کردن نود از شبکه"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showPopUp('updateJustNode')"><i onclick="showPopUp('updateJustNode')" class="fa fa-refresh" title="به روزرسانی نود"></i></a>
        </div>
    </div>
    <div id="settingwashing-navbar-M" class="navbar navbar-M w3-hide-medium w3-hide-large" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#current-plot" id="current-plot-icon" onclick="showTable()"><i onclick="showTable()" class="fa fa-backward" title="بازگشت به جدول لباسشویی ها"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showSettingWashingPlot()"><i onclick="showSettingWashingPlot()" class="fa fa-bar-chart" title="نمایش نمودار جریان این نود"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showPopUp('turnoffJustNode')"><i onclick="showPopUp('turnoffJustNode')" class="fa fa-power-off" title="قطع/وصل کردن نود از شبکه"></i></a>
            <a href="#current-plot" id="current-plot-icon" onclick="showPopUp('updateJustNode')"><i onclick="showPopUp('updateJustNode')" class="fa fa-refresh" title="به روزرسانی نود"></i></a>
        </div>
    </div>


    <!-- Washing PLOT -->
    <div id="washingplot-navbar-D" class="navbar navbar-D w3-hide-small" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#current-plot" id="current-plot-icon" onclick="showTable()"><i onclick="showTable()" class="fa fa-backward" title="بازگشت به جدول لباسشویی ها"></i></a>
            <a href="#fullscreen" id="fullScreen-icon" onclick="fullScreen('current-plot-washing')"><i onclick="fullScreen('current-plot-washing')" class="fa fa-search-plus" title="بزرگ نمایی به صورت تمام صفحه"></i></a>
        </div>
    </div>
    <div id="washingplot-navbar-M" class="navbar navbar-M w3-hide-medium w3-hide-large" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#current-plot" id="current-plot-icon" onclick="showTable()"><i onclick="showTable()" class="fa fa-backward" title="بازگشت به جدول لباسشویی ها"></i></a>
            <a href="#fullscreen" id="fullScreen-icon" onclick="fullScreen('current-plot-washing')"><i onclick="fullScreen('current-plot-washing')" class="fa fa-search-plus" title="بزرگ نمایی به صورت تمام صفحه"></i></a>
        </div>
    </div>


    <!-- INCOME PLOT and INFO -->
    <div id="incomeplot-navbar-D" class="navbar navbar-D w3-hide-small" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#income-total" id="income-total-icon" onclick="showTotalIncome()"><i onclick="showTotalIncome()" class="fa fa-dollar" title="نمایش عددی"></i></a>
            <a href="#income-plot" id="income-plot-icon" onclick="showPlotIncome()"><i onclick="showPlotIncome()" class="fa fa-area-chart" title="نمایش نموداری"></i></a>
        </div>
    </div>
    <div id="incomeplot-navbar-M" class="navbar navbar-M w3-hide-medium w3-hide-large" style="z-index: 10000;" hidden>
        <div class="center">
            <a href="#income-total" id="current-plot-icon" onclick="showTotalIncome()"><i onclick="showTotalIncome()" class="fa fa-dollar" title="نمایش عددی"></i></a>
            <a href="#income-plot" id="fullScreen-icon" onclick="showPlotIncome()"><i onclick="showPlotIncome()" class="fa fa-area-chart" title="نمایش نموداری"></i></a>
        </div>
    </div>

</body>

</html>


<script>
    function openSupport(evt, cityName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("support");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none ";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < x.length; i++) {
            tablinks[i].className = tablinks[i].className.replace("w3-border-green", " ");
        }
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.firstElementChild.className += "w3-border-green";
    }

    function showTotalIncome() {
        document.getElementById("income-system-plot").style.display = "none"
        document.getElementById("economic").style.display = "block"
    }

    function showPlotIncome() {
        document.getElementById("income-system-plot").style.display = "block"
        document.getElementById("economic").style.display = "none"

        setTimeout(() => {
            mainX = [1, 2, 3, 4]
            incomeY = [10, 12, 14, 17]
            paysY = [14, 9, 5, 4]
            var sumY = incomeY.map(function(item, index) {
                return item - paysY[index];
            })
            var income = {
                x: mainX,
                y: [10, 12, 14, 17],
                type: 'scatter',
                name: 'درآمد سیستم'
            };

            var pays = {
                x: mainX,
                y: [14, 9, 5, 4],
                type: 'scatter',
                name: 'مخارج سیستم'
            }

            var earn = {
                x: mainX,
                y: sumY,
                type: 'scatter',
                name: 'مجموع سود سیستم'
            }

            var data = [income, pays, earn];
            Plotly.newPlot('income-system-plot', data);
        }, 900);
    }

    function updateThisNode(msg) {
        document.getElementById("msg-modal-div").style.display = "block"
        document.getElementById("msg-modal-text").innerText = msg
        setTimeout(() => {
            document.getElementById("msg-modal-div").style.display = "none"
            document.getElementById("msg-modal-text").innerText = ""
        }, 1500);
    }

    function showPopUp(code) {
        document.getElementById("popup-div").style.display = "block"

        if (code == "updateJustNode") {
            document.getElementById("versionToUpdate").style.visibility = "visible"
            var washingNumberSpecial = document.getElementById("washing-number-special-D").innerText
            var selectElement = document.getElementById("versionToUpdate");
            var versionToUpdate = selectElement.options[selectElement.selectedIndex].value;
            console.log("VN: " + versionToUpdate)
            document.getElementById("yes-popup").onclick = function() {
                var washingNumberSpecial = document.getElementById("washing-number-special-D").innerText
                var selectElement = document.getElementById("versionToUpdate");
                var versionToUpdate = selectElement.options[selectElement.selectedIndex].value;
                $.ajax({
                    type: 'POST',
                    url: 'php/updateJustNode.php',
                    data: {
                        id: washingNumberSpecial,
                        version: versionToUpdate
                    },
                    success: function(response) {
                        response = JSON.parse(response)
                        console.log(response)
                    }
                });
            };
        }

        if (code == "turnoffJustNode") {
            var washingNumberSpecial = document.getElementById("washing-number-special-D").innerText
            document.getElementById("versionToUpdate").style.visibility = "hidden"
            console.log("off just")
            document.getElementById("yes-popup").onclick = function() {
                var washingNumberSpecial = document.getElementById("washing-number-special-D").innerText
                $.ajax({
                    type: 'POST',
                    url: 'php/turnoffJustNode.php',
                    data: {
                        id: washingNumberSpecial
                    },
                    success: function(response) {
                        response = JSON.parse(response)
                        console.log(response)
                    }
                });
            };

        }

        if (code == "updateAllNodes") {
            document.getElementById("versionToUpdate").style.visibility = "visible"
            var selectElement = document.getElementById("versionToUpdate");
            var versionToUpdate = selectElement.options[selectElement.selectedIndex].value;
            document.getElementById("yes-popup").onclick = function() {
                $.ajax({
                    type: 'POST',
                    url: 'php/updateAllNodes.php',
                    data: {
                        version: versionToUpdate
                    },
                    success: function(response) {
                        response = JSON.parse(response)
                        console.log(response)
                    }
                });
            };

        }

        if (code == "turnoffAllNodes") {
            document.getElementById("versionToUpdate").style.visibility = "hidden"
            console.log("off all")
            document.getElementById("yes-popup").onclick = function() {
                $.ajax({
                    type: 'POST',
                    url: 'php/turnoffAllNodes.php',
                    data: {

                    },
                    success: function(response) {
                        response = JSON.parse(response)
                        console.log(response)
                    }
                });
            };

        }
    }

    function hidecols() {
        $(document).ready(function() {
            var masked = $('.masked');
            $.each(masked, function() {
                var idx = $(this).index();
                $.each($('tr'), function() {
                    $(this).find('td').eq(idx).hide();
                });
            });
        });
    }

    hidecols()

    function searchFunc1(id) {
        var input, filter, table, tr, td0, td1, td2, td3, td4, td5, i, txtValue;
        input = document.getElementById(id);
        filter = input.value;
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td0 = tr[i].getElementsByTagName("td")[0];
            td1 = tr[i].getElementsByTagName("td")[1];
            td2 = tr[i].getElementsByTagName("td")[2];
            td3 = tr[i].getElementsByTagName("td")[3];
            td4 = tr[i].getElementsByTagName("td")[4];
            td5 = tr[i].getElementsByTagName("td")[5];
            if (td0) {
                txtValue0 = td0.textContent || td0.innerText;
                txtValue1 = td1.textContent || td1.innerText;
                txtValue2 = td2.textContent || td2.innerText;
                txtValue3 = td3.textContent || td3.innerText;
                txtValue4 = td4.textContent || td4.innerText;
                txtValue5 = td5.textContent || td5.innerText;

                if (txtValue0.toUpperCase().indexOf(filter) > -1 || txtValue1.toUpperCase().indexOf(filter) > -1 ||
                    txtValue2.toUpperCase().indexOf(filter) > -1 || txtValue3.toUpperCase().indexOf(filter) > -1 ||
                    txtValue4.toUpperCase().indexOf(filter) > -1 || txtValue5.toUpperCase().indexOf(filter) > -1) {

                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>



<script>
    function updateGraph() {
        document.getElementById("nodes").innerHTML = ''

        var w = window.innerWidth;
        var h = window.innerHeight;

        var keyc = true,
            keys = true,
            keyt = true,
            keyr = true,
            keyx = true,
            keyd = true,
            keyl = true,
            keym = true,
            keyh = true,
            key1 = true,
            key2 = true,
            key3 = true,
            key0 = true

        var focus_node = null,
            highlight_node = null;

        var text_center = false;
        var outline = false;

        var min_score = 0;
        var max_score = 1;

        var color = d3.scale.linear()
            .domain([min_score, (min_score + max_score) / 2, max_score])
            .range(["lime", "yellow", "red"]);

        var highlight_color = "blue";
        var highlight_trans = 0.1;

        var size = d3.scale.pow().exponent(1)
            .domain([1, 100])
            .range([8, 24]);

        var force = d3.layout.force()
            .linkDistance(60)
            .charge(-300)
            .size([w, h]);

        var default_node_color = "#ccc";
        //var default_node_color = "rgb(3,190,100)";
        var default_link_color = "#888";
        var nominal_base_node_size = 8;
        var nominal_text_size = 10;
        var max_text_size = 24;
        var nominal_stroke = 1.5;
        var max_stroke = 4.5;
        var max_base_node_size = 36;
        var min_zoom = 0.1;
        var max_zoom = 7;
        var svg = d3.select("#nodes").append("svg");
        var zoom = d3.behavior.zoom().scaleExtent([min_zoom, max_zoom])
        var g = svg.append("g");
        svg.style("cursor", "move");

        let r = Math.random().toString(36).substring(7);

        d3.json("php/graph.json?" + r + "=123", function(error, graph) {

            var linkedByIndex = {};
            graph.links.forEach(function(d) {
                linkedByIndex[d.source + "," + d.target] = true;
            });

            function isConnected(a, b) {
                return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
            }

            function hasConnections(a) {
                for (var property in linkedByIndex) {
                    s = property.split(",");
                    if ((s[0] == a.index || s[1] == a.index) && linkedByIndex[property]) return true;
                }
                return false;
            }

            force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();

            var link = g.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke-width", nominal_stroke)
                .style("stroke", function(d) {
                    if (isNumber(d.score) && d.score >= 0) return color(d.score);
                    else return default_link_color;
                })


            var node = g.selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")

            .call(force.drag)


            node.on("dblclick.zoom", function(d) {
                d3.event.stopPropagation();
                var dcx = (window.innerWidth / 2 - d.x * zoom.scale());
                var dcy = (window.innerHeight / 2 - d.y * zoom.scale());
                zoom.translate([dcx, dcy]);
                g.attr("transform", "translate(" + dcx + "," + dcy + ")scale(" + zoom.scale() + ")");


            });




            var tocolor = "fill";
            var towhite = "stroke";
            if (outline) {
                tocolor = "stroke"
                towhite = "fill"
            }



            var circle = node.append("path")


            .attr("d", d3.svg.symbol()
                .size(function(d) {
                    return Math.PI * Math.pow(size(d.size) || nominal_base_node_size, 2);
                })
                .type(function(d) {
                    return d.type;
                }))

            .style(tocolor, function(d) {
                    if (isNumber(d.score) && d.score >= 0) return color(d.score);
                    else return default_node_color;
                })
                //.attr("r", function(d) { return size(d.size)||nominal_base_node_size; })
                .style("stroke-width", nominal_stroke)
                .style(towhite, "white");


            var text = g.selectAll(".text")
                .data(graph.nodes)
                .enter().append("text")
                .attr("dy", ".35em")
                .style("font-size", nominal_text_size + "px")

            if (text_center)
                text.text(function(d) {
                    return d.id;
                })
                .style("text-anchor", "middle");
            else
                text.attr("dx", function(d) {
                    return (size(d.size) || nominal_base_node_size);
                })
                .text(function(d) {
                    return '\u2002' + d.id;
                });

            node.on("mouseover", function(d) {
                    set_highlight(d);
                })
                .on("mousedown", function(d) {
                    d3.event.stopPropagation();
                    focus_node = d;
                    set_focus(d)
                    if (highlight_node === null) set_highlight(d)

                }).on("mouseout", function(d) {
                    exit_highlight();

                }).on("dblclick", function(d) {
                    showSettingWashing(false, d.node_id)
                });

            d3.select(window).on("mouseup",
                function() {
                    if (focus_node !== null) {
                        focus_node = null;
                        if (highlight_trans < 1) {

                            circle.style("opacity", 1);
                            text.style("opacity", 1);
                            link.style("opacity", 1);
                        }
                    }

                    if (highlight_node === null) exit_highlight();
                });

            function exit_highlight() {
                highlight_node = null;
                if (focus_node === null) {
                    svg.style("cursor", "move");
                    if (highlight_color != "white") {
                        circle.style(towhite, "white");
                        text.style("font-weight", "normal");
                        link.style("stroke", function(o) {
                            return (isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color
                        });
                    }

                }
            }

            function set_focus(d) {
                if (highlight_trans < 1) {
                    circle.style("opacity", function(o) {
                        return isConnected(d, o) ? 1 : highlight_trans;
                    });

                    text.style("opacity", function(o) {
                        return isConnected(d, o) ? 1 : highlight_trans;
                    });

                    link.style("opacity", function(o) {
                        return o.source.index == d.index || o.target.index == d.index ? 1 : highlight_trans;
                    });
                }
            }


            function set_highlight(d) {
                svg.style("cursor", "pointer");
                if (focus_node !== null) d = focus_node;
                highlight_node = d;

                if (highlight_color != "white") {
                    circle.style(towhite, function(o) {
                        return isConnected(d, o) ? highlight_color : "white";
                    });
                    text.style("font-weight", function(o) {
                        return isConnected(d, o) ? "bold" : "normal";
                    });
                    link.style("stroke", function(o) {
                        return o.source.index == d.index || o.target.index == d.index ? highlight_color : ((isNumber(o.score) && o.score >= 0) ? color(o.score) : default_link_color);

                    });
                }
            }


            zoom.on("zoom", function() {

                var stroke = nominal_stroke;
                if (nominal_stroke * zoom.scale() > max_stroke) stroke = max_stroke / zoom.scale();
                link.style("stroke-width", stroke);
                circle.style("stroke-width", stroke);

                var base_radius = nominal_base_node_size;
                if (nominal_base_node_size * zoom.scale() > max_base_node_size) base_radius = max_base_node_size / zoom.scale();
                circle.attr("d", d3.svg.symbol()
                    .size(function(d) {
                        return Math.PI * Math.pow(size(d.size) * base_radius / nominal_base_node_size || base_radius, 2);
                    })
                    .type(function(d) {
                        return d.type;
                    }))

                //circle.attr("r", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); })
                if (!text_center) text.attr("dx", function(d) {
                    return (size(d.size) * base_radius / nominal_base_node_size || base_radius);
                });

                var text_size = nominal_text_size;
                if (nominal_text_size * zoom.scale() > max_text_size) text_size = max_text_size / zoom.scale();
                text.style("font-size", text_size + "px");

                g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            });

            svg.call(zoom);

            resize();
            //window.focus();
            d3.select(window).on("resize", resize).on("keydown", keydown);

            force.on("tick", function() {

                node.attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });
                text.attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });

                link.attr("x1", function(d) {
                        return d.source.x;
                    })
                    .attr("y1", function(d) {
                        return d.source.y;
                    })
                    .attr("x2", function(d) {
                        return d.target.x;
                    })
                    .attr("y2", function(d) {
                        return d.target.y;
                    });

                node.attr("cx", function(d) {
                        return d.x;
                    })
                    .attr("cy", function(d) {
                        return d.y;
                    });
            });

            function resize() {
                var width = window.innerWidth,
                    height = window.innerHeight;
                svg.attr("width", width).attr("height", height);

                force.size([force.size()[0] + (width - w) / zoom.scale(), force.size()[1] + (height - h) / zoom.scale()]).resume();
                w = width;
                h = height;
            }

            function keydown() {
                if (d3.event.keyCode == 32) {
                    force.stop();
                } else if (d3.event.keyCode >= 48 && d3.event.keyCode <= 90 && !d3.event.ctrlKey && !d3.event.altKey && !d3.event.metaKey) {
                    switch (String.fromCharCode(d3.event.keyCode)) {
                        case "C":
                            keyc = !keyc;
                            break;
                        case "S":
                            keys = !keys;
                            break;
                        case "T":
                            keyt = !keyt;
                            break;
                        case "R":
                            keyr = !keyr;
                            break;
                        case "X":
                            keyx = !keyx;
                            break;
                        case "D":
                            keyd = !keyd;
                            break;
                        case "L":
                            keyl = !keyl;
                            break;
                        case "M":
                            keym = !keym;
                            break;
                        case "H":
                            keyh = !keyh;
                            break;
                        case "1":
                            key1 = !key1;
                            break;
                        case "2":
                            key2 = !key2;
                            break;
                        case "3":
                            key3 = !key3;
                            break;
                        case "0":
                            key0 = !key0;
                            break;
                    }

                    link.style("display", function(d) {
                        var flag = vis_by_type(d.source.type) && vis_by_type(d.target.type) && vis_by_node_score(d.source.score) && vis_by_node_score(d.target.score) && vis_by_link_score(d.score);
                        linkedByIndex[d.source.index + "," + d.target.index] = flag;
                        return flag ? "inline" : "none";
                    });
                    node.style("display", function(d) {
                        return (key0 || hasConnections(d)) && vis_by_type(d.type) && vis_by_node_score(d.score) ? "inline" : "none";
                    });
                    text.style("display", function(d) {
                        return (key0 || hasConnections(d)) && vis_by_type(d.type) && vis_by_node_score(d.score) ? "inline" : "none";
                    });

                    if (highlight_node !== null) {
                        if ((key0 || hasConnections(highlight_node)) && vis_by_type(highlight_node.type) && vis_by_node_score(highlight_node.score)) {
                            if (focus_node !== null) set_focus(focus_node);
                            set_highlight(highlight_node);
                        } else {
                            exit_highlight();
                        }
                    }

                }
            }

        });

        function vis_by_type(type) {
            switch (type) {
                case "circle":
                    return keyc;
                case "square":
                    return keys;
                case "triangle-up":
                    return keyt;
                case "diamond":
                    return keyr;
                case "cross":
                    return keyx;
                case "triangle-down":
                    return keyd;
                default:
                    return true;
            }
        }

        function vis_by_node_score(score) {
            if (isNumber(score)) {
                if (score >= 0.666) return keyh;
                else if (score >= 0.333) return keym;
                else if (score >= 0) return keyl;
            }
            return true;
        }

        function vis_by_link_score(score) {
            if (isNumber(score)) {
                if (score >= 0.666) return key3;
                else if (score >= 0.333) return key2;
                else if (score >= 0) return key1;
            }
            return true;
        }

        function isNumber(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }
    }

    updateGraph()
</script>